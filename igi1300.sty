\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{igi1300}[2020/10/01 v1.0 French Mle 13/IGI 1300 stamps]
% Implements French classified information regulation (IGI 1300) stamps
% ISC = Informations et Supports Classifiés (Classified informations and materials)
% http://www.sgdsn.gouv.fr/uploads/2018/01/igi-1300-franxxais.pdf, Mle 13/IGI 1300 (page 176)

\RequirePackage{xstring}
\RequirePackage{xparse}
\RequirePackage{tikz}
\RequirePackage{varwidth}
\RequirePackage{ulem}

\def\Isc@Level{}
\newcommand\isc[1]{\def\Isc@Level{#1}}
\DeclareOption{NP}{\def\Isc@Level{NP}}
\DeclareOption{DR}{\def\Isc@Level{DR}}
\DeclareOption{CD}{\def\Isc@Level{CD}}
\DeclareOption{SD}{\def\Isc@Level{SD}}

\newif\ifIsc@SF\Isc@SFfalse
\DeclareOption{SF}{\Isc@SFtrue}

\ProcessOptions\relax

\def\Isc@Font{\sffamily\bfseries\fontsize{4mm}{4mm}\selectfont}
\newcommand\iscfont[1]{\def\Isc@Font{#1}}

\NewDocumentCommand\Isc@Stamp{o m o m o}{
    \hspace{0.25mm}%
    \tikz[baseline=(stamp.base)]{
        \node[
            rectangle,
            \IfValueT{#3}{draw},
            line width=\IfValueTF{#3}{#3}{0},
            inner xsep=\IfValueTF{#3}{4mm}{0},
            inner ysep=\IfValueTF{#3}{4mm}{0},
            minimum height=12mm,
            execute at begin node={\begin{varwidth}{95mm}\centering},
            execute at end node={\end{varwidth}},
            color=#2,
            text centered,
        ] (stamp) {
            \Isc@Font
            \IfEq{#1}{cover}{ % Cover page stamp
                \fontsize{5mm}{5mm}\selectfont
                \IfValueTF{#5}{ % Additionnal text
                    \uppercase{\uline{#4}}\\%
                    \normalfont\fontsize{3mm}{3mm}\selectfont #5%
                }{ % No additionnal text
                    \IfValueTF{#3}{\uppercase{#4}}{\uline{\uppercase{#4}}}%
                }
            }{ % Standard stamp
                    \IfValueTF{#3}{\uppercase{#4}}{\uline{\uppercase{#4}}}%
            }
        };
    }%
    \hspace{0.25mm}%
}

\NewDocumentCommand\ISC{s m}{
    \IfEqCase*{#2}{%
        {NP}{\Isc@Stamp[\IfBooleanT{#1}{cover}]{black}{Non protégé}}%
        {SF}{\Isc@Stamp[\IfBooleanT{#1}{cover}]{blue}[1mm]{Spécial France}}%
        {DR}{\Isc@Stamp[\IfBooleanT{#1}{cover}]{red}[1mm]{Diffusion Restreinte}[Ce document ne doit être communiqué qu'aux personnes ayant besoin d'en connaître.]}%
        {CD}{\Isc@Stamp[\IfBooleanT{#1}{cover}]{red}[1mm]{Confidentiel Défense}[Ce document ne doit être communiqué qu'aux personnes qualifiées pour le connaître.]}%
        {SD}{\Isc@Stamp[\IfBooleanT{#1}{cover}]{red}[1.5mm]{Secret Défense}[Toute personne qui détient ce document sans avoir qualité pour le connaître tombe sous le coup des dispositions du code pénal réprimant les atteintes au secret de la défense nationale.]}%
    }[\PackageWarning{tlp}{Only NP, SF, DR, CD and SD are defined, received '#1'}]%
}

\newcommand\iscstamp{\ISC{\Isc@Level}}

\newcommand\protectionstamp{\Isc@Stamp}